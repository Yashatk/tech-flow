<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cores de Veículos</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="/js/vue.min.js"></script>
</head>
<body>
<div id="app">
  <!-- Sidebar -->
  <div id="sidebar-container"></div>
  <!-- Header -->
  <div id="header-container"></div>
  <div class="container my-5 main-content" :style="mainContentStyle">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0">Cores de Veículos</h5>
      <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-orange me-3" @click="reloadData">
          <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
        </button>
        <button v-if="searchText" class="btn btn-sm btn-outline-secondary" @click="searchText = ''">
          <i class="bi bi-x-circle me-1"></i>Limpar filtros
        </button>
      </div>
    </div>
    
    <div class="card mb-4" :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label"></label>
            <div class="input-group">
              <span class="input-group-text" :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" v-model="searchText" placeholder="Digite para pesquisar..."
                     :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
            </div>
          </div>
        </div>
      </div>
      
    <!-- Summary information showing total and filtered count -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div :class="{'text-muted': theme === 'light', 'text-light': theme === 'dark'}">
        <span v-if="!loading">
          Mostrando {{ filteredColors.length }} de {{ colors.length }} cores
          <span v-if="searchText" class="fst-italic"> (filtros aplicados)</span>
        </span>
      </div>
    </div>
      
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" :class="{'table-dark': theme === 'dark'}" id="colorTable" width="100%" cellspacing="0">
            <thead>
              <tr>
                <th @click="sortBy('id')" style="cursor: pointer">
                  ID
                  <span v-if="sortKey === 'id'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th @click="sortBy('name')" style="cursor: pointer">
                  Nome
                  <span v-if="sortKey === 'name'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th @click="sortBy('sourceName')" style="cursor: pointer">
                  Principal
                  <span v-if="sortKey === 'parentName'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th @click="sortBy('sourceName')" style="cursor: pointer">
                  Origem
                  <span v-if="sortKey === 'sourceName'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th width="100">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="loading">
                <td colspan="4" class="text-center py-3">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Carregando dados...
                </td>
              </tr>
              <tr v-else-if="filteredColors.length === 0">
                <td colspan="4" class="text-center py-3">
                  Nenhuma cor encontrada
                </td>
              </tr>
              <tr v-for="color in filteredColors" :key="color.id">
                <td>{{ color.id }}</td>
                <td>{{ color.name }}</td>
                <td>{{ color.parentName || '-' }}</td>
                <td>{{ color.sourceName || '-' }}</td>
                <td>
                  <button class="btn btn-sm btn-orange me-1" @click="editColor(color)">
                    <i class="bi bi-pencil-square"></i> Editar
                  </button>
                  <!--
                  <button class="btn btn-sm btn-orange" @click="confirmDelete(color)">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                  -->
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div v-if="loading" class="text-center my-3">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Carregando...</span>
          </div>
        </div>
        <div v-if="error" class="alert alert-danger mt-3">{{ error }}</div>
      </div>
    </div>
  </div>
</div>
<script>
const SYS_PAGE_NAME="color.html";
const SYS_MENU_ID="menu-color";

const app = new Vue({
  el: '#app',
  data: {
    theme: localStorage.getItem('centaura-theme') || 'light',
    colors: [],
    loading: false,
    error: null,
    currentPage: 1,
    pageSize: 100,
    searchText: '',
    sortKey: 'id',
    sortOrder: 'asc'
  },
  computed: {
    mainContentStyle() {
      return {
        paddingTop: '50px',
        marginLeft: document.body.classList.contains('sidebar-hidden') ? '0' : '220px',
        transition: 'margin-left 0.2s'
      };
    },
    filteredColors() {
      // First filter the items based on search text
      let filteredItems;
      if (!this.searchText || this.searchText.trim() === '') {
        filteredItems = this.colors;
      } else {
        const searchTerm = this.searchText.toLowerCase().trim();
        filteredItems = this.colors.filter(item => {
          return (
            (item.name && item.name.toLowerCase().includes(searchTerm)) ||
            (item.parentName && item.parentName.toLowerCase().includes(searchTerm)) ||
            (item.sourceName && item.sourceName.toLowerCase().includes(searchTerm)) ||
            (item.id && String(item.id).includes(searchTerm))
          );
        });
      }
      
      // Then sort the filtered items
      return this.sortItems(filteredItems, this.sortKey, this.sortOrder);
    }
  },
  methods: {
    sortBy(key) {
      // If already sorting by this key, reverse the order
      if (this.sortKey === key) {
        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        // Otherwise, set new key and default to ascending
        this.sortKey = key;
        this.sortOrder = 'asc';
      }
    },
    
    sortItems(items, key, order) {
      return [...items].sort((a, b) => {
        // Handle nested properties (e.g., 'parent.name')
        let aValue, bValue;
        
        if (key.includes('.')) {
          const parts = key.split('.');
          aValue = a;
          bValue = b;
          
          for (const part of parts) {
            aValue = aValue ? aValue[part] : undefined;
            bValue = bValue ? bValue[part] : undefined;
          }
        } else {
          aValue = a[key];
          bValue = b[key];
        }
        
        // Handle nulls/undefined
        if (aValue === undefined || aValue === null) aValue = '';
        if (bValue === undefined || bValue === null) bValue = '';
        
        // Handle numeric sorting
        if (!isNaN(aValue) && !isNaN(bValue)) {
          return order === 'asc' ? aValue - bValue : bValue - aValue;
        }
        
        // Handle string sorting
        aValue = String(aValue).toLowerCase();
        bValue = String(bValue).toLowerCase();
        
        if (aValue < bValue) return order === 'asc' ? -1 : 1;
        if (aValue > bValue) return order === 'asc' ? 1 : -1;
        return 0;
      });
    },
    
    fetchColors() {
      this.loading = true;
      this.error = null;
      
      fetch(`api/vehicle/color?page=${this.currentPage}&pageSize=${this.pageSize}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro ao carregar dados da API');
          }
          return response.json();
        })
        .then(data => {
          if (data && data.obj) {
            this.colors = data.obj;
            console.log('Colors loaded:', this.colors);
          } else {
            this.colors = [];
            console.log('No colors found or invalid response format');
          }
          this.loading = false;
        })
        .catch(err => {
          this.error = `Erro ao carregar dados: ${err.message}`;
          this.loading = false;
          console.error('API Error:', err);
        });
    },
    reloadData() {
      this.fetchColors();
    },
    editColor(color) {
      console.log('Edit color:', color);
      // Implement edit functionality here
      alert('Editar cor: ' + color.name);
    },
    confirmDelete(color) {
      if (confirm(`Deseja realmente excluir a cor "${color.name}"?`)) {
        console.log('Delete color:', color);
        // Implement delete functionality here
      }
    }
  },
  mounted() {
    document.body.className = this.theme;
    this.fetchColors();
  }
});

</script>
<script src="header.js"></script>
<style>
  th[style="cursor: pointer"]:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .table-dark th[style="cursor: pointer"]:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  th .bi-sort-up, th .bi-sort-down {
    margin-left: 5px;
    font-size: 0.8em;
  }
</style>
</body>
</html>
