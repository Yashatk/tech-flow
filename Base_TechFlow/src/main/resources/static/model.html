<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modelos de Veículos</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="/js/vue.min.js"></script>
</head>
<body>
<div id="app">
  <!-- Sidebar -->
  <div id="sidebar-container"></div>
  <!-- Header -->
  <div id="header-container"></div>
  <div class="container my-5 main-content" :style="mainContentStyle">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0">Modelos de Veículos</h5>
      <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-orange me-3" @click="reloadData">
          <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
        </button>
        <button v-if="searchText" class="btn btn-sm btn-outline-secondary" @click="searchText = ''">
          <i class="bi bi-x-circle me-1"></i>Limpar filtros
        </button>
      </div>
    </div>
    
    <div class="card mb-4" :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label"></label>
            <div class="input-group">
              <span class="input-group-text" :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" v-model="searchText" placeholder="Digite para pesquisar..."
                     :class="{'bg-dark text-white border-secondary': theme === 'dark'}">
            </div>
          </div>
        </div>
      </div>
      
    <!-- Summary information showing total and filtered count -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div :class="{'text-muted': theme === 'light', 'text-light': theme === 'dark'}">
        <span v-if="!loading">
          Mostrando {{ filteredModels.length }} de {{ totalItems }} modelos
          <span v-if="searchText" class="fst-italic"> (filtros aplicados)</span>
        </span>
      </div>
    </div>
      
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" :class="{'table-dark': theme === 'dark'}" id="modelTable" width="100%" cellspacing="0">
            <thead>
              <tr>
                <th @click="sortBy('id')" style="cursor: pointer">
                  ID
                  <span v-if="sortKey === 'id'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th @click="sortBy('name')" style="cursor: pointer">
                  Nome
                  <span v-if="sortKey === 'name'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th @click="sortBy('brandName')" style="cursor: pointer">
                  Marca
                  <span v-if="sortKey === 'brandName'">
                    <i :class="['bi', sortOrder === 'asc' ? 'bi-sort-up' : 'bi-sort-down']"></i>
                  </span>
                </th>
                <th width="100">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="loading">
                <td colspan="4" class="text-center py-3">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Carregando dados...
                </td>
              </tr>
              <tr v-else-if="filteredModels.length === 0">
                <td colspan="4" class="text-center py-3">
                  Nenhum modelo encontrado
                </td>
              </tr>
              <tr v-for="model in filteredModels" :key="model.id">
                <td>{{ model.id }}</td>
                <td>{{ model.name }}</td>
                <td>{{ model.brandName || '-' }}</td>
                <td>
                  <button class="btn btn-sm btn-orange me-1" @click="editModel(model)">
                    <i class="bi bi-pencil-square"></i> Editar
                  </button>
                  <!--
                  <button class="btn btn-sm btn-orange" @click="confirmDelete(model)">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                  -->
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div v-if="loading" class="text-center my-3">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only"></span>
          </div>
        </div>
        <div v-if="error" class="alert alert-danger mt-3">{{ error }}</div>
        
        <!-- Pagination Controls -->
        <div v-if="!loading && totalPages > 1" class="d-flex justify-content-between align-items-center mt-3">
          <div class="d-flex align-items-center">
            <label class="me-2">Itens por página:</label>
            <select v-model="pageSizeSelect" class="form-select form-select-sm" style="width: 70px;" @change="changePageSize">
              <option v-for="size in pageSizeOptions" :key="size" :value="size">{{ size }}</option>
            </select>
          </div>
          <nav aria-label="Navegação de páginas">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(1)" aria-label="Primeira">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)" aria-label="Anterior">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              
              <li v-for="page in displayedPageNumbers" :key="page" class="page-item" :class="{ active: currentPage === page }">
                <a class="page-link" href="#" @click.prevent="changePage(page)">{{ page }}</a>
              </li>
              
              <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)" aria-label="Próxima">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(totalPages)" aria-label="Última">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>
            </ul>
          </nav>
          <div>
            Página {{ currentPage }} de {{ totalPages }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const SYS_PAGE_NAME="model.html";
const SYS_MENU_ID="menu-model";

const app = new Vue({
  el: '#app',
  data: {
    theme: localStorage.getItem('centaura-theme') || 'light',
    models: [],
    loading: false,
    error: null,
    currentPage: 1,
    currentClientPage: 1,
    pageSize: 100,
    pageSizeSelect: 100,
    pageSizeOptions: [5, 10, 25, 50, 100],
    totalItems: 0,
    searchText: '',
    sortKey: 'id',
    sortOrder: 'asc'
  },
  computed: {
    mainContentStyle() {
      return {
        paddingTop: '50px',
        marginLeft: document.body.classList.contains('sidebar-hidden') ? '0' : '220px',
        transition: 'margin-left 0.2s'
      };
    },
    filteredModels() {
      // First filter the items based on search text
      let filteredItems;
      if (!this.searchText || this.searchText.trim() === '') {
        filteredItems = this.models;
      } else {
        const searchTerm = this.searchText.toLowerCase().trim();
        filteredItems = this.models.filter(item => {
          return (
            (item.name && item.name.toLowerCase().includes(searchTerm)) ||
            (item.brandName && item.brandName.toLowerCase().includes(searchTerm)) ||
            (item.id && String(item.id).includes(searchTerm))
          );
        });
      }
      
      // Then sort the filtered items
      const sortedItems = this.sortItems(filteredItems, this.sortKey, this.sortOrder);
      
      // Apply client-side pagination if searching
      if (this.searchText) {
        const start = (this.currentClientPage - 1) * this.pageSizeSelect;
        const end = start + this.pageSizeSelect;
        return sortedItems.slice(start, end);
      }
      
      return sortedItems;
    },
    totalPages() {
      if (this.searchText) {
        // If searching, calculate based on filtered items before pagination
        const totalItems = this.models.filter(item => {
          const searchTerm = this.searchText.toLowerCase().trim();
          return (
            (item.name && item.name.toLowerCase().includes(searchTerm)) ||
            (item.brandName && item.brandName.toLowerCase().includes(searchTerm)) ||
            (item.id && String(item.id).includes(searchTerm))
          );
        }).length;
        return Math.max(1, Math.ceil(totalItems / this.pageSizeSelect));
      } else {
        // Use total rows from API response
        return Math.max(1, Math.ceil(this.totalItems / this.pageSizeSelect));
      }
    },
    displayedPageNumbers() {
      const pages = [];
      const maxVisible = 5; // Maximum number of page numbers to show
      
      // Calculate range of pages to display
      let startPage = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(this.totalPages, startPage + maxVisible - 1);
      
      // Adjust start page if we're near the end
      if (endPage - startPage + 1 < maxVisible && startPage > 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }
      
      // Generate page numbers
      for (let i = startPage; i <= endPage; i++) {
        pages.push(i);
      }
      
      return pages;
    }
  },
  methods: {
    sortBy(key) {
      // If already sorting by this key, reverse the order
      if (this.sortKey === key) {
        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        // Otherwise, set new key and default to ascending
        this.sortKey = key;
        this.sortOrder = 'asc';
      }
    },
    
    sortItems(items, key, order) {
      return [...items].sort((a, b) => {
        // Handle nested properties (e.g., 'parent.name')
        let aValue, bValue;
        
        if (key.includes('.')) {
          const parts = key.split('.');
          aValue = a;
          bValue = b;
          
          for (const part of parts) {
            aValue = aValue ? aValue[part] : undefined;
            bValue = bValue ? bValue[part] : undefined;
          }
        } else {
          aValue = a[key];
          bValue = b[key];
        }
        
        // Handle nulls/undefined
        if (aValue === undefined || aValue === null) aValue = '';
        if (bValue === undefined || bValue === null) bValue = '';
        
        // Handle numeric sorting
        if (!isNaN(aValue) && !isNaN(bValue)) {
          return order === 'asc' ? aValue - bValue : bValue - aValue;
        }
        
        // Handle string sorting
        aValue = String(aValue).toLowerCase();
        bValue = String(bValue).toLowerCase();
        
        if (aValue < bValue) return order === 'asc' ? -1 : 1;
        if (aValue > bValue) return order === 'asc' ? 1 : -1;
        return 0;
      });
    },
    
    fetchModels() {
      this.loading = true;
      this.error = null;
      
      fetch(`api/vehicle/model?page=${this.currentPage}&pageSize=${this.pageSize}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro ao carregar dados da API');
          }
          return response.json();
        })
        .then(data => {
          if (data && data.obj) {
            this.models = data.obj;
            // Get total rows from data.totalRows
            if (data.totalRows !== undefined) {
              this.totalItems = data.totalRows;
            } else {
              // Fallback to array length if totalRows is not available
              this.totalItems = this.models.length;
            }
            console.log('Models loaded:', this.models);
          } else {
            this.models = [];
            this.totalItems = 0;
            console.log('No models found or invalid response format');
          }
          this.loading = false;
        })
        .catch(err => {
          this.error = `Erro ao carregar dados: ${err.message}`;
          this.loading = false;
          console.error('API Error:', err);
        });
    },
    reloadData() {
      this.currentPage = 1;
      this.currentClientPage = 1;
      this.fetchModels();
    },
    changePage(page) {
      if (page < 1 || page > this.totalPages || page === this.currentPage) return;
      
      if (this.searchText) {
        // If searching, handle pagination client-side
        this.currentClientPage = page;
      } else {
        // Otherwise, fetch from server
        this.currentPage = page;
        this.fetchModels();
      }
    },
    changePageSize(event) {
      this.pageSize = this.pageSizeSelect;
      this.currentPage = 1;
      this.currentClientPage = 1;
      this.fetchModels();
    },
    editModel(model) {
      console.log('Edit model:', model);
      // Implement edit functionality here
      alert('Editar modelo: ' + model.name);
    },
    confirmDelete(model) {
      if (confirm(`Deseja realmente excluir o modelo "${model.name}"?`)) {
        console.log('Delete model:', model);
        // Implement delete functionality here
      }
    }
  },
  mounted() {
    document.body.className = this.theme;
    this.fetchModels();
  }
});

</script>
<script src="header.js"></script>
<style>
  th[style="cursor: pointer"]:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .table-dark th[style="cursor: pointer"]:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  th .bi-sort-up, th .bi-sort-down {
    margin-left: 5px;
    font-size: 0.8em;
  }
</style>
</body>
</html>
