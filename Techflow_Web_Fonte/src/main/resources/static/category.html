<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TechFlow</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/style-table.css">
  <script src="/js/vue.min.js"></script>  
</head>
<body>
<div id="app">
  <!-- Sidebar -->
  <div id="sidebar-container"></div>
  <!-- Header -->
  <div id="header-container"></div>
  <div class="my-5 main-content" :style="mainContentStyle">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Categorias</h3>
            <button class="btn btn-outline-primary" @click="showModal = true">Incluir Categoria</button>
        </div>

        <div class="d-flex flex-wrap gap-3 mb-3">
          <div>
            <label for="filterKey" class="form-label mb-0">Localizar</label>
            <input id="filterKey" type="text" class="form-control" v-model="filters.key" placeholder="Buscar...">
          </div>
          <div class="align-self-end">
              <button class="btn btn-outline-primary" @click="fetchData">Localizar</button>
          </div>
        </div>

        <table class="table table-bordered table-hover" v-if="tableData.length" >
        <thead class="table-light">
            <tr>
            <th @click="sortBy('id')" style="cursor:pointer" width="100px">
                ID
                <span v-if="sortColumn === 'id'">
                <span v-if="sortAsc">&#9650;</span>
                <span v-else>&#9660;</span>
                </span>
            </th>
            <th @click="sortBy('category')" style="cursor:pointer">
                Categoria
                <span v-if="sortColumn === 'category'">
                <span v-if="sortAsc">&#9650;</span>
                <span v-else>&#9660;</span>
                </span>
            </th>
            <th style="width:90px;"></th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="cat in sortedData" :key="cat.id">
            <td>{{ cat.id }}</td>
            <td>{{ cat.category }}</td>
            <td align="center">
            <button class="btn btn-sm btn-outline-primary" @click="editData(cat)">
                Editar
            </button>
            </td>
            </tr>
        </tbody>
        </table>
        <div v-else class="text-muted">Nenhuma categoria encontrada.</div>


         <!-- Modal -->
        <div class="modal fade" tabindex="-1" role="dialog" :class="{show: showModal}" style="display: block;" v-if="showModal">
            <div class="modal-dialog" role="document">
            <div class="modal-content" :class="{ 'dark-modal': theme === 'dark' }">
                <div class="modal-header">
                    <h5 class="modal-title">Incluir Categoria</h5>
                    <button type="button" class="btn btn-outline-secondary" @click="closeModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form @submit.prevent="saveData">
                    <div class="modal-body">

                    <div class="form-group" v-if="newItem.id && newItem.id > 0">
                        <label for="categoryId">Id</label>
                        <input type="text" class="form-control" id="categoryId" v-model="newItem.id" disabled>
                    </div>

                    <div class="form-group">
                        <label for="categoryName">Categoria</label>
                        <input type="text" class="form-control" id="categoryName" v-model="newItem.category" required>
                    </div>

                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @click="closeModal">Cancelar</button>
                    <button type="submit" class="btn btn-outline-primary">Salvar</button>
                    </div>
                </form>
                </div>
            </div>
        </div>
        <div v-if="showModal" class="modal-backdrop fade show"></div>


  </div>
</div>
<script>
const SYS_PAGE_NAME="category.html";
const SYS_MENU_ID="menu-category";

const app = new Vue({
  el: '#app',
  data: {
    theme: localStorage.getItem('centaura-theme') || 'light',
    sessionData: JSON.parse(localStorage.getItem('techflow_session')) || {},
    tableData: [],
    sortColumn: 'category',
    sortAsc: true,
    showModal: false,
    newItem: { category: '' },
    filters: {
      key: ''
    }
  },
  computed: {
    mainContentStyle() {
      return {
        paddingTop: '50px',
        marginLeft: document.body.classList.contains('sidebar-hidden') ? '0' : '220px',
        transition: 'margin-left 0.2s'
      };
    },
    sortedData() {
      let filtered = this.tableData;
      if (this.filters.key) {
        const key = this.filters.key.toLowerCase();
        filtered = filtered.filter(cat =>
          (cat.category && cat.category.toLowerCase().includes(key)) ||
          (cat.id && cat.id.toString().includes(key))
        );
      }
      return [...filtered].sort((a, b) => {
        let col = this.sortColumn;
        if (a[col] < b[col]) return this.sortAsc ? -1 : 1;
        if (a[col] > b[col]) return this.sortAsc ? 1 : -1;
        return 0;
      });
    }
  },
  methods: {
    fetchData() {
        fetch('/api/support/ticket/category')
        .then(r => r.json())
        .then(data => {
            this.tableData = data.obj;
        })
        .catch(() => {
            this.tableData = [];
        });
    },
    sortBy(column) {
      if (this.sortColumn === column) {
        this.sortAsc = !this.sortAsc;
      } else {
        this.sortColumn = column;
        this.sortAsc = true;
      }
    },
    closeModal() {
      this.showModal = false;
      this.newItem = { id: '', category: '' };
    },
    saveData() {
      fetch('/api/support/ticket/category', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.newItem)
      })
      .then(r => r.json())
      .then(() => {
        this.closeModal();
        this.fetchData();
      })
      .catch(() => {
        alert('Erro ao incluir categoria');
      });
    },
    editData(cat) {
        this.newItem = { ...cat };
        this.showModal = true;
    }
  },
  mounted() {
    document.body.className = this.theme;    
    this.fetchData();
  }
});


</script>
<script src="header.js"></script>
<style>

</style>
</body>
</html>


